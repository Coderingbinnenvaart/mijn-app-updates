<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADN Ventilatie</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="logo.png"> 
    
    <style>
        /* ======================================================= */
        /* BASIS CONFIGURATIE (STANDAARD: NACHTMODUS) */
        /* ======================================================= */
        :root {
            --bg-dark: #0a111f; /* Zeer diep donkerblauw */
            --card-base: #1c2638; /* Diepblauw-grijs metaal */
            --accent-blue: #3b82f6; /* New Mexico Blauw */
            --accent-teal: #14b8a6; /* New Mexico Turquoise (ADN accent) */
            --panel-bg: #151f30; /* Iets lichtere achtergrond voor panelen */
            --text-color-primary: #e2e8f0;
            --text-color-secondary: #a0aec0;
            --border-color-dark: #374151;
            --shadow-color-dark: rgba(0, 0, 0, 0.4);
            --input-bg: #e2e8f0; /* Lichte achtergrond voor input */
            --input-text: #111827; /* Donkere tekst in input */
            
            --text-on-accent: #111827; 
            --text-on-accent-light: #ffffff; 
            --border-color-light: #e5e7eb; /* Light mode border */
            --shadow-color-light: rgba(0, 0, 0, 0.1); /* Light mode shadow */
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark); 
            padding-top: 80px; 
            color: var(--text-color-primary); 
            transition: background-color 0.3s, color 0.3s; 
        }

        /* Navigatiebalk */
        .navbar {
            height: 80px; 
            box-shadow: 0 4px 15px -5px var(--shadow-color-dark);
            z-index: 1000;
            background-color: #111827; 
            border-bottom: 3px solid var(--accent-blue);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .navbar-title {
            font-weight: 800;
            color: var(--accent-blue);
            text-shadow: 0 0 5px rgba(59, 130, 246, 0.5); 
            transition: color 0.3s, text-shadow 0.3s;
        }
        
        /* PANEEL STYLING (Tool-Panel) */
        .tool-panel {
            background-color: var(--panel-bg);
            border-radius: 0.5rem;
            padding: 3rem; /* Meer padding voor centrale kaart */
            box-shadow: 0 5px 25px rgba(59, 130, 246, 0.25); /* Sterkere gloed */
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color-dark); 
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }
        
        /* VERTICALE ACCENT LIJN (Aangepast voor ADN-kleur) */
        .tool-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px; 
            height: 100%;
            background-color: var(--accent-teal); /* Gebruik ADN/Teal accent */
            box-shadow: 1px 0 10px rgba(20, 184, 166, 0.6);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .panel-title {
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 0.15em; 
            color: var(--accent-teal); /* Gebruik ADN/Teal accent */
            border-bottom: 2px solid var(--accent-teal);
            padding-bottom: 0.5rem;
            display: block;
            transition: color 0.3s, border-color 0.3s;
        }
        
        /* Input Styling */
        .default-input {
            background-color: var(--input-bg);
            color: var(--input-text);
            border: 1px solid var(--border-color-dark);
            transition: border-color 0.3s;
        }
        
        .default-input:focus {
            border-color: var(--accent-blue);
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        /* Spinner & Knoppen */
        .spinner {
            border-top-color: var(--accent-blue);
            border-left-color: var(--accent-blue);
        }
        .btn-elegant-gradient {
            background-image: linear-gradient(to right, var(--accent-blue) 0%, var(--accent-teal) 100%);
            color: var(--text-on-accent);
        }
        .btn-elegant-gradient:hover {
            box-shadow: 0 4px 15px var(--shadow-color-dark);
        }
        
/* FILE INPUT STYLING */
        #file-label {
            /* ... bestaande stijlen ... */
            transition: all 0.2s;
        }
        #file-label:hover {
            /* ... bestaande stijlen ... */
            border-color: var(--accent-teal);
            color: var(--accent-teal);
        }
        
        /* NIEUWE STIJL VOOR DRAG-AND-DROP */
        #file-label[style*="border-color: var(--accent-blue)"] {
            /* Visuele feedback als het bestand boven het vak hangt */
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); 
            border: 2px dashed var(--accent-blue) !important;
            color: var(--accent-blue) !important;
        }
        /* Einde NIEUWE STIJL */

        #file-name {
            /* ... bestaande stijlen ... */
        }

        /* RESULT DIV STYLING */
        .result-panel-box {
            background-color: var(--card-base);
            border: 1px solid var(--border-color-dark);
        }
        .result-panel-box-inner {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color-dark);
        }
        .text-blue-600 { /* Container number */
            color: var(--accent-blue);
        }
        .text-teal-700 { /* Locatie titel */
            color: var(--accent-teal);
        }
        .bg-teal-100 { /* UN badge background */
            background-color: rgba(20, 184, 166, 0.2); 
            color: var(--accent-teal);
        }
        
        /* ======================================================= */
        /* MENU KNOP & PANEEL STYLING */
        /* ======================================================= */
        .menu-grid-button {
            display: grid;
            grid-template-columns: repeat(2, 10px);
            grid-template-rows: repeat(2, 10px);
            gap: 4px;
            padding: 10px;
            background: none;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative; 
            z-index: 1010; 
        }
        .menu-grid-button:hover {
            transform: scale(1.05);
        }
        .menu-grid-dot {
            background-color: var(--accent-blue);
            border-radius: 2px;
            box-shadow: 0 0 3px rgba(59, 130, 246, 0.5);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        
        #menu-panel {
            position: fixed;
            top: 83px; 
            right: 20px; 
            background-color: var(--panel-bg);
            border: 1px solid var(--accent-blue);
            border-radius: 0.5rem;
            box-shadow: 0 5px 15px var(--shadow-color-dark);
            width: 280px; 
            z-index: 1000;
            padding: 10px; 
            
            opacity: 0;
            transform: translateX(20px);
            visibility: hidden;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out, visibility 0.3s, background-color 0.3s;
        }

        #menu-panel.active {
            opacity: 1;
            transform: translateX(0);
            visibility: visible;
        }

        #menu-links-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); 
            gap: 10px; 
        }

        .menu-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100px; 
            text-align: center;
            border-radius: 0.5rem; 
            
            background-color: var(--border-color-dark); 
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-color-primary);
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s, background-color 0.3s, color 0.3s;
            line-height: 1.2;
        }

        .menu-link:hover {
            background-color: var(--accent-blue);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 3px 5px rgba(59, 130, 246, 0.3);
        }
        .menu-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        /* Modus schakelaar neemt volledige breedte in (grid-column: span 2) */
        #mode-toggle-link {
             background-color: #374151; 
             grid-column: span 2; 
        }

        /* ======================================================= */
        /* MODAL STYLING (Aangepast voor Dark Mode) */
        /* ======================================================= */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000; /* Zorg ervoor dat het boven alles zit */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7); /* Donkerdere overlay */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: var(--panel-bg);
            color: var(--text-color-primary);
            padding: 24px;
            border-radius: 12px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 4px 15px var(--shadow-color-dark);
            border: 1px solid var(--border-color-dark);
        }
        .modal-content h2, .modal-content h3 {
            color: var(--text-color-primary);
        }
        .modal-content label {
            color: var(--text-color-secondary);
        }
        .close-button {
            color: var(--text-color-secondary);
            font-size: 28px;
            font-weight: bold;
            transition: color 0.2s;
        }
        .close-button:hover,
        .close-button:focus {
            color: var(--accent-blue);
            cursor: pointer;
        }
        
        /* ======================================================= */
        /* DAGMODUS OVERRIDES (LIGHT MODE) */
        /* ======================================================= */
        body.light-mode {
            --bg-dark: #f3f4f6; 
            --card-base: #ffffff; 
            --accent-blue: #1e3a8a; 
            --accent-teal: #047857; 
            --panel-bg: #ffffff;
            --text-color-primary: #1f2937;
            --text-color-secondary: #4b5563;
            --input-bg: #f9fafb;
            --input-text: #1f2937;
            
            background-color: var(--bg-dark);
            color: var(--text-color-primary);
        }

        body.light-mode .navbar {
            background-color: var(--panel-bg);
            box-shadow: 0 4px 15px -5px var(--shadow-color-light);
            border-bottom-color: var(--accent-blue);
        }
        
        /* Panelen */
        body.light-mode .tool-panel {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color-light);
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
        }
        body.light-mode .modal-content {
            background-color: var(--panel-bg);
            border: 1px solid var(--border-color-light);
            box-shadow: 0 4px 15px var(--shadow-color-light);
        }
        body.light-mode .modal-content h2, body.light-mode .modal-content h3 {
             color: var(--input-text);
        }

        /* Knoppen/Accenten */
        body.light-mode .btn-elegant-gradient:hover {
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        body.light-mode .result-panel-box-inner {
            background-color: #f7f7f7;
        }
        body.light-mode .bg-teal-100 { /* UN badge background */
            background-color: #d1fae5; 
        }
    </style>
</head>
<body class="flex flex-col items-center min-h-screen relative">
    
    <header class="navbar fixed top-0 left-0 w-full flex items-center justify-between px-8">
        <div class="text-2xl navbar-title tracking-widest">
            ADN DOCUMENT
        </div>

        <button id="menu-toggle" class="menu-grid-button" aria-label="Open Hoofdmenu" aria-controls="menu-panel">
            <div class="menu-grid-dot"></div>
            <div class="menu-grid-dot"></div>
            <div class="menu-grid-dot"></div>
            <div class="menu-grid-dot"></div>
        </button>
    </header>
    
    <nav id="menu-panel" role="navigation" aria-label="Hoofdnavigatie">
        <div id="menu-links-grid">
            <a href="index.html" class="menu-link">
                <span class="menu-icon" role="img" aria-label="Home">üè†</span>
                <span>Dashboard</span>
            </a>
            <a href="waterstanden.html" class="menu-link">
                <span class="menu-icon" role="img" aria-label="Brug">üåâ</span>
                <span>Brughoogte</span>
            </a>
            <a href="reizen.html" class="menu-link">
                <span class="menu-icon" role="img" aria-label="Kompas">üß≠</span>
                <span>Reizen</span>
            </a>
            <a href="adn.html" class="menu-link" style="background-color: var(--accent-teal); color: var(--text-on-accent);">
                <span class="menu-icon" role="img" aria-label="Vlam">üî•</span>
                <span>ADN Document</span>
            </a>
            
            <a href="#" id="mode-toggle-link" class="menu-link" role="button">
                <span class="menu-icon" role="img" aria-label="Modus schakelen">üåì</span>
                <span>Modus Schakelen</span>
            </a>
        </div>
    </nav>
    
    <div id="terminalSelectionModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold mb-4" style="color: var(--accent-blue);">Selecteer rapport</h2>
            <div id="modal-options" class="flex flex-col gap-2"></div>
        </div>
    </div>

    <div id="reportInputModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeInputModal">&times;</span>
            <h2 class="text-2xl font-bold mb-4" style="color: var(--accent-blue);">Rapportgegevens</h2>
            <div class="mb-4">
                <label for="meterName" class="block text-sm font-medium">Naam van de meter:</label>
                <input type="text" id="meterName" class="default-input mt-1 block w-full rounded-md shadow-sm p-2">
            </div>
            <div class="mb-4">
                <label for="reportDate" class="block text-sm font-medium">Datum:</label>
                <input type="date" id="reportDate" class="default-input mt-1 block w-full rounded-md shadow-sm p-2">
            </div>

            <div class="mb-4 p-3 rounded-lg" style="background-color: var(--card-base);">
                <h3 class="text-lg font-medium">Na het laden, voor vertrek:</h3>
                <div class="flex items-center gap-2 mt-2">
                    <label for="timeBeforeDeparture" class="block text-sm font-medium">Starttijd:</label>
                    <input type="time" id="timeBeforeDeparture" class="default-input flex-grow rounded-md shadow-sm p-2">
                </div>
            </div>

            <div class="mb-4 p-3 rounded-lg" style="background-color: var(--card-base);">
                <h3 class="text-lg font-medium">1 uur na vertrek:</h3>
                <div class="flex items-center gap-2 mt-2">
                    <label for="timeAfterDeparture" class="block text-sm font-medium">Starttijd:</label>
                    <input type="time" id="timeAfterDeparture" class="default-input flex-grow rounded-md shadow-sm p-2">
                </div>
            </div>
            <button id="downloadFinalReportButton" class="w-full btn-elegant-gradient font-semibold py-3 px-4 rounded-xl shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                Download rapport
            </button>
        </div>
    </div>

    <div class="flex flex-col items-center w-full max-w-3xl pt-16 pb-8">
        <button id="reportButton" class="absolute top-20 right-4 btn-elegant-gradient text-white font-semibold py-2 px-4 rounded-xl shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed hidden no-print">
            Rapport maken
        </button>

        <div class="tool-panel w-full text-center no-print" style="max-width: 100%; padding: 3rem;"> 
            <h1 class="panel-title text-center">ADN Ventilatie</h1>
            <p class="text-md text-gray-400 mb-8 font-light">Vind containers met UN-nummers die overeenkomen met de ADN-ventilatievereisten.</p>
            
            <div class="mb-6">
                <label for="ediFile" class="block text-gray-400 text-sm font-medium mb-2 text-left">
                    Selecteer een EDI-bestand (.edi):
                </label>
                <label for="ediFile" id="file-label" class="relative w-full block cursor-pointer p-8 rounded-xl border-2 border-dashed transition-colors">
                    <div class="flex flex-col items-center">
                        <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-4-4v-1a4 4 0 014-4h2a4 4 0 014 4v1a4 4 0 014 4"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 17a3 3 0 100-6 3 3 0 000 6zM8 12.5a.5.5 0 11-1 0 .5.5 0 011 0zM12 12.5a.5.5 0 11-1 0 .5.5 0 011 0z"></path></svg>
                        <span class="font-medium text-sm">Klik om een bestand te kiezen</span>
                        <span id="file-name" class="text-sm mt-1 font-normal"></span>
                    </div>
                </label>
                <input type="file" id="ediFile" accept=".edi" class="hidden">
            </div>

            <button id="processButton" class="w-full btn-elegant-gradient font-semibold py-3 px-4 rounded-xl shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                Verwerk Bestand
            </button>

            <div id="loading" class="mt-8 hidden justify-center items-center">
                <div class="spinner"></div>
                <p class="ml-4 text-gray-400 font-medium">Bestand wordt verwerkt...</p>
            </div>

            <div id="result" class="mt-8 text-left"></div>
        </div>
    </div>

<script>
    const menuToggle = document.getElementById('menu-toggle');
    const menuPanel = document.getElementById('menu-panel');
    const modeToggleLink = document.getElementById('mode-toggle-link');
    const body = document.body;
    
    // ====================================================================
    // MENU & MODUS LOGICA (Behoud)
    // ====================================================================

    function updateAriaAttributes(isExpanded) {
        menuToggle.setAttribute('aria-expanded', isExpanded);
        menuPanel.setAttribute('aria-hidden', !isExpanded);
    }

    function switchMode(isLightMode) {
        const iconSpan = modeToggleLink.querySelector('span:first-child');
        const textSpan = modeToggleLink.querySelector('span:last-child');

        if (isLightMode) {
            body.classList.add('light-mode');
            iconSpan.textContent = 'üåô';
            textSpan.textContent = 'Nacht Modus';
            modeToggleLink.setAttribute('aria-label', 'Schakel naar nachtmodus');
            localStorage.setItem('theme', 'light');
        } else {
            body.classList.remove('light-mode');
            iconSpan.textContent = '‚òÄÔ∏è';
            textSpan.textContent = 'Dag Modus';
            modeToggleLink.setAttribute('aria-label', 'Schakel naar dagmodus');
            localStorage.setItem('theme', 'dark');
        }
        
        // Zorg ervoor dat de actieve link (ADN Document) de accentkleur behoudt
        const adnLink = document.querySelector('a[href="adn.html"]');
        if (adnLink) {
            adnLink.style.backgroundColor = 'var(--accent-teal)';
            adnLink.style.color = 'var(--text-on-accent)';
        }
    }

    // 1. INITIALISATIE
    updateAriaAttributes(false);
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') {
        switchMode(true);
    } else {
        switchMode(false);
    }

    // 2. EVENTS
    menuToggle.addEventListener('click', function(event) {
        event.stopPropagation(); 
        const isActive = menuPanel.classList.toggle('active');
        updateAriaAttributes(isActive);
    });

    document.addEventListener('click', function(event) {
        const isActive = menuPanel.classList.contains('active');
        if (isActive && !menuPanel.contains(event.target) && !menuToggle.contains(event.target)) {
            menuPanel.classList.remove('active');
            updateAriaAttributes(false);
        }
    });

    modeToggleLink.addEventListener('click', function(event) {
        event.preventDefault(); 
        const isLightMode = body.classList.contains('light-mode');
        switchMode(!isLightMode); 
    });


    // ====================================================================
    // ADN DOCUMENT LOGICA (Inclusief Drag-and-Drop)
    // ====================================================================

    document.addEventListener('DOMContentLoaded', () => {
        const fileInput = document.getElementById('ediFile');
        const processButton = document.getElementById('processButton');
        const loadingDiv = document.getElementById('loading');
        const resultDiv = document.getElementById('result');
        const fileNameSpan = document.getElementById('file-name');
        const fileLabel = document.getElementById('file-label'); // VOOR D&D
        const reportButton = document.getElementById('reportButton');
        const terminalSelectionModal = document.getElementById('terminalSelectionModal');
        const reportInputModal = document.getElementById('reportInputModal');
        const modalOptionsDiv = document.getElementById('modal-options');
        const closeTerminalModal = document.querySelector('#terminalSelectionModal .close-button');
        const closeInputModal = document.querySelector('#reportInputModal .close-button');
        const meterNameInput = document.getElementById('meterName');
        const reportDateInput = document.getElementById('reportDate');
        const downloadFinalReportButton = document.getElementById('downloadFinalReportButton');
        const timeBeforeDepartureInput = document.getElementById('timeBeforeDeparture');
        const timeAfterDepartureInput = document.getElementById('timeAfterDeparture');

        // ... (De grote Set met UN-nummers en locationAbbreviations blijven hier)
        const predefinedUnNumbers = new Set(['1001', '1010', '1011', '1012', '1016', '1023', '1026', '1027', '1030', '1032', '1033', '1035', '1036', '1037', '1038', '1039', '1040', '1041', '1049', '1051', '1053', '1055', '1057', '1060', '1061', '1063', '1064', '1071', '1075', '1077', '1081', '1082', '1083', '1085', '1086', '1087', '1088', '1089', '1090', '1091', '1092', '1093', '1098', '1099', '1100', '1104', '1105', '1106', '1107', '1108', '1109', '1110', '1111', '1112', '1113', '1114', '1120', '1123', '1125', '1126', '1127', '1128', '1129', '1130', '1131', '1133', '1134', '1135', '1136', '1139', '1143', '1144', '1145', '1146', '1147', '1148', '1149', '1150', '1152', '1153', '1154', '1155', '1156', '1157', '1158', '1159', '1160', '1161', '1162', '1163', '1164', '1165', '1166', '1167', '1169', '1170', '1171', '1172', '1173', '1175', '1176', '1177', '1178', '1179', '1180', '1181', '1182', '1183', '1184', '1185', '1188', '1189', '1190', '1191', '1192', '1193', '1194', '1195', '1196', '1197', '1198', '1199', '1201', '1202', '1203', '1204', '1206', '1207', '1208', '1210', '1212', '1213', '1214', '1216', '1218', '1219', '1220', '1221', '1222', '1223', '1224', '1228', '1229', '1230', '1231', '1233', '1234', '1235', '1237', '1238', '1239', '1242', '1243', '1244', '1245', '1246', '1247', '1248', '1249', '1250', '1251', '1259', '1261', '1262', '1263', '1264', '1265', '1266', '1267', '1268', '1272', '1274', '1275', '1276', '1277', '1278', '1279', '1280', '1281', '1282', '1286', '1287', '1288', '1289', '1292', '1293', '1294', '1295', '1296', '1297', '1298', '1299', '1300', '1301', '1302', '1303', '1304', '1305', '1306', '1307', '1308', '1340', '1360', '1363', '1389', '1390', '1391', '1392', '1393', '1394', '1395', '1396', '1397', '1398', '1400', '1401', '1402', '1403', '1404', '1405', '1407', '1408', '1409', '1410', '1411', '1413', '1414', '1415', '1417', '1418', '1419', '1420', '1421', '1422', '1423', '1426', '1427', '1428', '1432', '1433', '1435', '1436', '1545', '1569', '1603', '1604', '1613', '1614', '1648', '1695', '1714', '1722', '1723', '1724', '1747', '1767', '1779', '1815', '1816', '1860', '1862', '1863', '1865', '1866', '1870', '1911', '1912', '1914', '1915', '1916', '1917', '1918', '1919', '1920', '1921', '1922', '1923', '1928', '1950', '1953', '1954', '1955', '1957', '1959', '1961', '1962', '1964', '1965', '1966', '1967', '1969', '1971', '1972', '1978', '1986', '1987', '1988', '1989', '1990', '1991', '1992', '1993', '1994', '1999', '2010', '2011', '2012', '2013', '2023', '2029', '2034', '2035', '2037', '2044', '2045', '2046', '2047', '2048', '2049', '2050', '2051', '2052', '2053', '2054', '2055', '2056', '2057', '2058', '2059', '2192', '2199', '2200', '2202', '2203', '2204', '2210', '2211', '2218', '2219', '2222', '2227', '2233', '2234', '2238', '2241', '2242', '2243', '2244', '2245', '2246', '2247', '2248', '2251', '2252', '2256', '2257', '2258', '2260', '2263', '2264', '2265', '2266', '2270', '2271', '2275', '2276', '2277', '2278', '2282', '2283', '2284', '2285', '2286', '2287', '2288', '2293', '2295', '2296', '2297', '2298', '2301', '2302', '2303', '2309', '2310', '2313', '2319', '2323', '2324', '2325', '2329', '2330', '2332', '2333', '2334', '2335', '2336', '2337', '2338', '2339', '2340', '2341', '2342', '2343', '2344', '2345', '2346', '2347', '2348', '2350', '2351', '2352', '2353', '2354', '2356', '2357', '2358', '2359', '2360', '2361', '2362', '2363', '2364', '2366', '2367', '2368', '2370', '2371', '2372', '2373', '2374', '2375', '2376', '2377', '2378', '2379', '2380', '2381', '2382', '2383', '2384', '2385', '2386', '2387', '2388', '2389', '2390', '2391', '2392', '2393', '2394', '2395', '2396', '2397', '2398', '2399', '2400', '2401', '2402', '2403', '2404', '2405', '2406', '2407', '2409', '2410', '2411', '2412', '2413', '2414', '2416', '2417', '2418', '2419', '2436', '2438', '2452', '2453', '2454', '2456', '2457', '2458', '2459', '2460', '2461', '2463', '2470', '2473', '2474', '2477', '2478', '2480', '2481', '2482', '2483', '2484', '2485', '2486', '2487', '2488', '2493', '2498', '2502', '2514', '2517', '2520', '2521', '2524', '2526', '2527', '2528', '2529', '2534', '2535', '2536', '2541', '2554', '2558', '2560', '2561', '2589', '2603', '2604', '2605', '2606', '2607', '2608', '2609', '2610', '2611', '2612', '2614', '2615', '2616', '2617', '2618', '2619', '2620', '2621', '2622', '2623', '2624', '2668', '2676', '2683', '2684', '2685', '2686', '2707', '2709', '2710', '2733', '2734', '2740', '2741', '2742', '2743', '2744', '2749', '2752', '2758', '2760', '2762', '2764', '2813', '2826', '2835', '2838', '2840', '2841', '2842', '2844', '2850', '2870', '2903', '2920', '2924', '2929', '2933', '2934', '2935', '2943', '2945', '2947', '2950', '2965', '2968', '2983', '2985', '2986', '2988', '2991', '2993', '2995', '2997', '3005', '3009', '3011', '3013', '3015', '3017', '3019', '3021', '3022', '3023', '3024', '3025', '3054', '3056', '3064', '3065', '3071', '3072', '3073', '3092', '3101', '3102', '3103', '3104', '3105', '3106', '3107', '3108', '3109', '3110', '3111', '3112', '3113', '3114', '3115', '3116', '3117', '3118', '3119', '3120', '3129', '3130', '3131', '3132', '3134', '3135', '3138', '3148', '3150', '3153', '3154', '3160', '3161', '3165', '3167', '3168', '3169', '3170', '3175', '3208', '3209', '3248', '3252', '3256', '3269', '3271', '3272', '3273', '3274', '3275', '3276', '3277', '3278', '3279', '3286', '3292', '3294', '3295', '3300', '3305', '3309', '3312', '3314', '3336', '3343', '3346', '3347', '3350', '3351', '3354', '3355', '3357', '3358', '3362', '3371', '3374', '3379', '3383', '3384', '3393', '3394', '3395', '3396', '3397', '3398', '3399', '3401', '3402', '3403', '3404', '3463', '3468', '3469', '3470', '3473', '3475', '3476', '3478', '3479', '3482', '3483', '3484', '3488', '3489', '3490', '3491', '3494', '3501', '3504', '3514', '3517', '3518', '3519', '3520', '3521', '3522', '3523', '3525'
        ]);
        const locationAbbreviations = {
            '00CTS': 'CTS', '00DCH': 'DCH', '00RRT': 'RRT', 'BAYER': 'BAYER', 'NOTNE': 'Neuss Trimidal', '0KRAW': 'Kramer', '00RWG': 'RWG', 'UWTFR': 'UWT Frisohaven', '0APMA': 'APM 2', '00DDN': 'DDN', '00DDE': 'DDE', '00EMX': 'Euromax','00NIT': 'Neuss','00RRT': 'RRT','00DCT': 'DECETE',
        };

        let currentResults = {};
        let selectedLocation = null;
        let tripCode = 'N/A';

        // Functie om de verwerking te starten (gebruikt door zowel klik als D&D)
        function startProcessing(file) {
             if (!file) {
                return;
            }

            // Controleer op bestandstype (optioneel, maar goed voor .edi)
            if (!file.name.toLowerCase().endsWith('.edi')) {
                alert('Selecteer a.u.b. een geldig EDI-bestand (.edi).');
                // Reset de input als deze via de klik kwam
                fileInput.value = ''; 
                fileNameSpan.textContent = '';
                processButton.disabled = true;
                return;
            }
            
            // Stel de file input in op het gedropte bestand (nodig voor formulier/state)
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
            
            fileNameSpan.textContent = file.name;
            processButton.disabled = false;
            resultDiv.innerHTML = '';
            reportButton.classList.add('hidden');
            
            // Roep de processButton click handler aan om de daadwerkelijke verwerking te starten
            processButton.click();
        }

        // ====================================================================
        // DRAG AND DROP LISTENERS
        // ====================================================================

        fileLabel.addEventListener('dragover', (event) => {
            event.preventDefault(); // Zorgt ervoor dat 'drop' wordt geactiveerd
            fileLabel.style.borderColor = 'var(--accent-blue)';
            fileLabel.style.backgroundColor = 'var(--card-base)'; 
        });

        fileLabel.addEventListener('dragleave', (event) => {
            event.preventDefault();
            fileLabel.style.borderColor = 'var(--border-color-dark)'; // Standaard kleur
            fileLabel.style.backgroundColor = 'var(--card-base)';
        });

        fileLabel.addEventListener('drop', (event) => {
            event.preventDefault();
            fileLabel.style.borderColor = 'var(--border-color-dark)'; // Standaard kleur
            fileLabel.style.backgroundColor = 'var(--card-base)';

            const droppedFiles = event.dataTransfer.files;
            if (droppedFiles.length > 0) {
                startProcessing(droppedFiles[0]); // Start de verwerking met het gedropte bestand
            }
        });

        // ====================================================================
        // KLIK EN PROCES LISTENERS
        // ====================================================================

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                 startProcessing(fileInput.files[0]);
            }
        });

        processButton.addEventListener('click', () => {
            const file = fileInput.files[0];
            if (!file) {
                return;
            }

            processButton.disabled = true;
            loadingDiv.classList.remove('hidden');
            loadingDiv.classList.add('flex');
            resultDiv.innerHTML = '';
            reportButton.classList.add('hidden');

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const ediContent = event.target.result;
                    const segments = ediContent.split("'");

                    const locationData = {};
                    let currentLoadingLocation = 'Niet gespecificeerd';
                    let currentContainerNumber = null;

                    // ... (EDI-parsering logica blijft ongewijzigd)
                    segments.forEach(segment => {
                        const trimmedSegment = segment.trim();

                        if (trimmedSegment.startsWith('TDT+20+')) {
                            const parts = trimmedSegment.split('+');
                            if (parts.length > 2) {
                                tripCode = parts[2].trim(); 
                            }
                        }
                        else if (trimmedSegment.startsWith('UNB+')) {
                            const parts = trimmedSegment.split('+');
                            if (parts.length > 5 && parts[5].startsWith('ZEM')) {
                                tripCode = parts[5].substring(3);
                            } 
                            else if (parts.length > 5) {
                                const referenceComponent = parts[parts.length - 1]; 
                                tripCode = referenceComponent.replace(/"/g, '').split(':')[0].trim();
                            }
                        }

                        if (trimmedSegment.startsWith('LOC+9+')) {
                            const parts = trimmedSegment.split('+');
                            let locCode = parts[2];
                            currentLoadingLocation = locationAbbreviations[locCode] || locCode;
                        }

                        if (trimmedSegment.startsWith('EQD+CN+')) {
                            const parts = trimmedSegment.split('+');
                            currentContainerNumber = parts[2];
                        }

                        if (trimmedSegment.startsWith('DGS+IMD+')) {
                            const parts = trimmedSegment.split('+');
                            if (parts.length > 3) {
                                const unNumber = parts[3];

                                if (unNumber && predefinedUnNumbers.has(unNumber) && currentContainerNumber) {
                                    if (!locationData[currentLoadingLocation]) {
                                        locationData[currentLoadingLocation] = {};
                                    }
                                    if (!locationData[currentLoadingLocation][currentContainerNumber]) {
                                        locationData[currentLoadingLocation][currentContainerNumber] = new Set();
                                    }
                                    locationData[currentLoadingLocation][currentContainerNumber].add(unNumber);
                                }
                            }
                        }
                    });

                    currentResults = locationData;
                    loadingDiv.classList.remove('flex');
                    loadingDiv.classList.add('hidden');
                    processButton.disabled = false;

                    let foundCount = 0;
                    let resultHtml = `<h2 class="text-2xl font-bold mb-6" style="color: var(--accent-blue);">Gevonden overeenkomsten voor ventilatievereisten:</h2>`;

                    const sortedLocations = Object.keys(locationData).sort();

                    if (sortedLocations.length > 0) {
                        for (const location of sortedLocations) {
                            const containers = locationData[location];
                            if (Object.keys(containers).length > 0) {
                                foundCount++;
                                resultHtml += `
                                    <div class="p-6 result-panel-box rounded-2xl shadow-sm mb-6">
                                        <div class="flex items-center mb-4">
                                            <svg class="w-6 h-6 text-teal-600 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path></svg>
                                            <h3 class="text-xl font-bold text-teal-700">Laadplaats: ${location}</h3>
                                        </div>
                                        ${Object.entries(containers).map(([container, unNumbers]) => `
                                            <div class="p-4 result-panel-box-inner rounded-xl shadow-sm mb-3">
                                                <p class="font-semibold">Containernummer: <span class="text-blue-600">${container}</span></p>
                                                <p class="text-sm text-gray-500 mt-2 mb-1">UN-nummers:</p>
                                                <ul class="flex flex-wrap gap-2 text-sm">
                                                    ${Array.from(unNumbers).map(un => `
                                                        <li class="bg-teal-100 px-3 py-1 rounded-full font-semibold">
                                                            UN ${un}
                                                        </li>
                                                    `).join('')}
                                                </ul>
                                            </div>
                                        `).join('')}
                                    </div>
                                `;
                            }
                        }
                    }

                    if (foundCount > 0) {
                        resultDiv.innerHTML = resultHtml;
                        resultDiv.className = 'mt-8';
                        reportButton.classList.remove('hidden');
                    } else {
                        resultDiv.innerHTML = `
                            <div class="bg-red-50 border border-red-200 p-6 rounded-xl shadow-lg">
                                <p class="text-red-700 font-semibold text-center">
                                    <span class="text-3xl">üò¢</span><br>Geen van de vooraf ingestelde UN-nummers is gevonden in het bestand.
                                </p>
                            </div>
                        `;
                        resultDiv.className = 'mt-8';
                    }
                } catch (error) {
                    loadingDiv.classList.remove('flex');
                    loadingDiv.classList.add('hidden');
                    processButton.disabled = false;
                    resultDiv.innerHTML = `
                        <div class="bg-red-50 border border-red-200 p-6 rounded-xl shadow-lg">
                            <p class="text-red-700 font-semibold text-center">
                                <span class="text-3xl">‚ö†Ô∏è</span><br>Er is een fout opgetreden bij het verwerken van het bestand: ${error.message}
                            </p>
                        </div>
                    `;
                    resultDiv.className = 'mt-8';
                    console.error('Fout bij het verwerken van het bestand:', error);
                }
            };
            reader.readAsText(file);
        });

        // ... (Modal/Rapport logica blijft ongewijzigd)
        
        reportButton.addEventListener('click', () => {
            if (Object.keys(currentResults).length === 0) {
                alert('Geen resultaten om te rapporteren.');
                return;
            }

            modalOptionsDiv.innerHTML = '';
            Object.keys(currentResults).sort().forEach(location => {
                const button = document.createElement('button');
                button.textContent = `Rapport voor ${location}`;
                button.className = 'w-full btn-elegant-gradient text-white font-semibold py-2 px-4 rounded-xl shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500';
                button.onclick = () => {
                    selectedLocation = location;
                    terminalSelectionModal.style.display = 'none';
                    reportInputModal.style.display = 'flex';
                };
                modalOptionsDiv.appendChild(button);
            });
            terminalSelectionModal.style.display = 'flex';
        });

        closeTerminalModal.onclick = () => {
            terminalSelectionModal.style.display = 'none';
        };

        closeInputModal.onclick = () => {
            reportInputModal.style.display = 'none';
        };

        window.onclick = (event) => {
            if (event.target == terminalSelectionModal) {
                terminalSelectionModal.style.display = 'none';
            }
            if (event.target == reportInputModal) {
                reportInputModal.style.display = 'none';
            }
        };

        downloadFinalReportButton.addEventListener('click', () => {
            const meterName = meterNameInput.value;
            const reportDate = reportDateInput.value;
            const timeBeforeDeparture = timeBeforeDepartureInput.value;
            const timeAfterDeparture = timeAfterDepartureInput.value;

            if (!meterName || !reportDate || !timeBeforeDeparture || !timeAfterDeparture) {
                alert('Vul alle velden in om het rapport te genereren.');
                return;
            }

            generateAndDownloadReportHTML(selectedLocation, meterName, reportDate, timeBeforeDeparture, timeAfterDeparture, tripCode);
            reportInputModal.style.display = 'none';
        });

        function addMinutesAndHandleDate(baseDate, baseTime, minutesToAdd) {
            if (!baseDate || !baseTime) return { time: '', date: '' };

            const [year, month, day] = baseDate.split('-').map(Number);
            const [hours, mins] = baseTime.split(':').map(Number);

            const dateObj = new Date(year, month - 1, day, hours, mins);
            dateObj.setMinutes(dateObj.getMinutes() + minutesToAdd);

            const newHours = String(dateObj.getHours()).padStart(2, '0');
            const newMins = String(dateObj.getMinutes()).padStart(2, '0');
            const newYear = dateObj.getFullYear();
            const newMonth = String(dateObj.getMonth() + 1).padStart(2, '0');
            const newDay = String(dateObj.getDate()).padStart(2, '0');

            return {
                time: `${newHours}:${newMins}`,
                date: `${newDay}-${newMonth}-${newYear}`
            };
        }

        function generateAndDownloadReportHTML(location, meterName, reportDate, startTimeBefore, startTimeAfter, tripCode) {
            const containers = currentResults[location] || {};
            const allUnNumbers = new Set();
            Object.values(containers).forEach(unNumbers => {
                unNumbers.forEach(un => allUnNumbers.add(un));
            });
            const allUnNumbersString = Array.from(allUnNumbers).join(', ');

            const allHolds = ['1/4', '5/8', '9/13', '14/17'];

            const generateTableRows = (baseTime, baseDate) => {
                let rowsHtml = '';
                allHolds.forEach((holdGroup, index) => {
                    const { time, date } = addMinutesAndHandleDate(baseDate, baseTime, index * 4);
                    const doneByValue = meterName;
                    const oxyValue = '20,9%';
                    const lelValue = '0%';

                    rowsHtml += `
                        <tr>
                            <td>Ruim ${holdGroup}</td>
                            <td>${oxyValue}</td>
                            <td>${lelValue}</td>
                            <td>${time}</td>
                            <td>${date}</td>
                            <td>${doneByValue}</td>
                        </tr>
                    `;
                });
                return rowsHtml;
            };

            let secondMeasurementDate = reportDate;
            const beforeDateObj = new Date(reportDate + 'T' + startTimeBefore);
            const afterDateObj = new Date(reportDate + 'T' + startTimeAfter);
            if (afterDateObj < beforeDateObj) {
                const [year, month, day] = reportDate.split('-').map(Number);
                const newDate = new Date(year, month - 1, day);
                newDate.setDate(newDate.getDate() + 1);
                secondMeasurementDate = `${newDate.getFullYear()}-${String(newDate.getMonth() + 1).padStart(2, '0')}-${String(newDate.getDate()).padStart(2, '0')}`;
            }

            const containersHtmlBefore = generateTableRows(startTimeBefore, reportDate);
            const containersHtmlAfter = generateTableRows(startTimeAfter, secondMeasurementDate);

            // De print-CSS is aangepast om de nieuwe look over te nemen
            const reportHtml = `
                <!DOCTYPE html>
                <html lang="nl">
                <head>
                    <meta charset="UTF-8">
                    <title>ADN Ventilatie Rapport - ${location}</title>
                    <style>
                        body {
                            font-family: 'Inter', sans-serif;
                            margin: 0;
                            padding: 0;
                            color: #333;
                            line-height: 1.6;
                        }
                        .report-container {
                            width: 21cm;
                            min-height: 29.7cm;
                            margin: 0 auto;
                            padding: 2cm;
                            box-sizing: border-box;
                            background-color: #ffffff;
                        }
                        .report-header {
                            text-align: center;
                            margin-bottom: 3rem;
                            padding-bottom: 1.5rem;
                            border-bottom: 2px solid #1e3a8a; /* Accent Blue */
                            position: relative;
                        }
                        .report-header .logo-placeholder {
                            font-size: 24px;
                            font-weight: 700;
                            color: #4b5563;
                            margin-bottom: 10px;
                        }
                        .report-header h1 {
                            font-size: 32px;
                            font-weight: 800;
                            color: #1e3a8a;
                            margin: 0;
                        }
                        .report-header h2 {
                            font-size: 16px;
                            color: #6b7280;
                            margin-top: 5px;
                            font-weight: 400;
                        }

                        .info-section {
                            background-color: #f3f4f6;
                            border-radius: 8px;
                            padding: 1.5rem;
                            margin-bottom: 2.5rem;
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 1rem 2rem;
                            border: 1px solid #e5e7eb;
                        }
                        .info-label {
                            font-weight: 600;
                            color: #4b5563;
                        }

                        h2.section-title {
                            font-size: 22px;
                            font-weight: 700;
                            color: #047857; /* Accent Teal */
                            margin-top: 2.5rem;
                            margin-bottom: 1rem;
                            border-left: 4px solid #047857;
                            padding-left: 8px;
                        }
                        table.data-table {
                            width: 100%;
                            border-collapse: collapse;
                            font-size: 14px;
                            border: 1px solid #ddd;
                            margin-bottom: 2rem;
                        }
                        .data-table th, .data-table td {
                            padding: 10px 15px;
                            text-align: left;
                            border: 1px solid #e5e7eb;
                        }
                        .data-table th {
                            background-color: #e5e7eb;
                            font-weight: 700;
                            color: #1f2937;
                            text-transform: uppercase;
                        }
                        .data-table tr:nth-child(even) {
                            background-color: #f9fafb;
                        }

                        @page {
                            size: A4;
                            margin: 2cm;
                        }
                        @media print {
                            .report-footer {
                                position: fixed;
                                bottom: 0;
                                left: 0;
                                right: 0;
                                width: 100%;
                                padding: 1rem 1.5cm;
                                text-align: right;
                                background-color: #fff;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="report-container">
                        <div class="report-header">
                            <div class="logo-placeholder">ADN</div>
                            <h1>Ventilatie Rapport</h1>
                            <h2>Meetresultaten voor gasmeting</h2>
                        </div>

                        <div class="info-section">
                            <div class="info-item">
                                <span class="info-label">Terminal:</span>
                                <span class="info-value">${location}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Reiscode:</span>
                                <span class="info-value">${tripCode}</span>
                            </div>

                            <div class="info-item">
                                <span class="info-label">Ve01:</span>
                                <span class="info-value">${allUnNumbersString || 'Geen UN-nummers gevonden'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Datum rapport:</span>
                                <span class="info-value">${reportDate.split('-').reverse().join('-')}</span>
                            </div>
                        </div>

                        <h2 class="section-title">Na het laden, voor vertrek</h2>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ruim</th>
                                    <th>OXY</th>
                                    <th>LEL</th>
                                    <th>Tijd</th>
                                    <th>Datum</th>
                                    <th>Naam</th>
                                </tr>
                            </thead>
                            <tbody>${containersHtmlBefore}</tbody>
                        </table>

                        <h2 class="section-title">1 uur na vertrek</h2>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ruim</th>
                                    <th>OXY</th>
                                    <th>LEL</th>
                                    <th>Tijd</th>
                                    <th>Datum</th>
                                    <th>Naam</th>
                                    </tr>
                                </thead>
                                <tbody>${containersHtmlAfter}</tbody>
                            </table>

                        </div>
                    </body>
                    </html>
            `;

            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.open();
                printWindow.document.write(reportHtml);
                printWindow.document.close();
                printWindow.onload = () => {
                    printWindow.print();
                };
            } else {
                alert('De pop-up blokkeerder heeft het venster geblokkeerd. Sta pop-ups toe en probeer het opnieuw.');
            }
        }
    });
</script>
</body>
</html>