<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reizen - MS New Mexico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: #f1f5f9; min-height: 100vh; scroll-behavior: smooth; }
        .glass-card { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; }
        .input-dark { background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(255, 255, 255, 0.1); color: white; border-radius: 12px; padding: 12px; width: 100%; transition: all 0.2s; }
        .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; font-weight: 800; border-radius: 12px; transition: all 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4); }
        .stat-card { background: linear-gradient(180deg, rgba(30, 41, 59, 0.4) 0%, rgba(15, 23, 42, 0) 100%); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 20px; padding: 20px; text-align: center; }
        .sync-badge { background: rgba(16, 185, 129, 0.1); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.2); padding: 4px 12px; border-radius: 99px; font-size: 10px; font-weight: 700; }
        .loading-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        #input-sectie {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, opacity 0.5s;
            opacity: 0;
        }
        #input-sectie.visible {
            max-height: 1000px;
            opacity: 1;
            margin-bottom: 2.5rem;
        }
    </style>
</head>
<body class="pb-12">

    <nav class="sticky top-0 z-50 bg-slate-950/80 backdrop-blur-md border-b border-white/5 px-8 py-5 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20">
                <i class="fas fa-ship text-white text-xl"></i>
            </div>
            <div>
                <h1 class="text-lg font-black uppercase tracking-tight text-white">MS New Mexico</h1>
                <span class="sync-badge" id="sync-text">Cloud Verbonden</span>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="maakPDF()" class="w-10 h-10 bg-red-500/10 border border-red-500/20 text-red-500 rounded-xl flex items-center justify-center hover:bg-red-500 hover:text-white transition-all shadow-lg" title="Exporteer Rapport">
                <i class="fas fa-file-pdf"></i>
            </button>

            <button onclick="toggleInvoer()" class="flex items-center gap-2 bg-emerald-500 text-white px-4 py-2 rounded-xl font-bold text-sm shadow-lg shadow-emerald-500/20 hover:scale-105 transition-transform">
                <i class="fas fa-plus"></i>
                <span class="hidden md:inline">Nieuwe Reis</span>
            </button>
            
            <select id="filter-jaar" onchange="laadDataVanCloud()" class="bg-slate-900 border border-white/10 rounded-lg px-3 py-1 text-xs font-bold text-white outline-none">
                <option value="2026">2026</option>
                <option value="2025">2025</option>
                <option value="2024">2024</option>
            </select>
            <button onclick="laadDataVanCloud()" class="text-slate-400 hover:text-white transition-colors px-2">
                <i class="fas fa-sync-alt" id="refresh-icon"></i>
            </button>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-6 mt-10">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="stat-card">
                <p class="text-slate-500 text-[10px] font-black uppercase tracking-widest mb-1">Totaal Reizen (<span id="stats-jaar">2026</span>)</p>
                <h2 id="stat-reizen" class="text-4xl font-black text-white">0</h2>
            </div>
            <div class="stat-card">
                <p class="text-slate-500 text-[10px] font-black uppercase tracking-widest mb-1">Containers</p>
                <h2 id="stat-containers" class="text-4xl font-black text-blue-500">0</h2>
            </div>
            <div class="stat-card">
                <p class="text-slate-500 text-[10px] font-black uppercase tracking-widest mb-1">Totaal Tonnage</p>
                <h2 id="stat-tonnage" class="text-4xl font-black text-emerald-500">0.0</h2>
            </div>
        </div>

        <div id="input-sectie" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="glass-card p-8 border-blue-500/20">
                <h3 class="font-bold mb-6 text-white text-sm tracking-widest uppercase">Handmatige Invoer</h3>
                <form onsubmit="verwerkInvoer(event)" class="space-y-4">
                    <input type="text" id="reis-nr" class="input-dark" placeholder="Reisnummer">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="reis-kisten" class="input-dark" placeholder="Containers">
                        <input type="number" step="0.01" id="reis-ton" class="input-dark" placeholder="Ton">
                    </div>
                    <button type="submit" class="btn-primary w-full py-4 uppercase text-xs tracking-widest">Opslaan</button>
                </form>
            </div>

            <div class="glass-card p-8 border-emerald-500/20 flex flex-col justify-center">
                <h3 class="font-bold mb-6 text-white text-sm tracking-widest uppercase text-center">BAPLIE Automatische Analyse</h3>
                <div class="space-y-4">
                    <div class="border-2 border-dashed border-white/10 rounded-xl p-10 text-center hover:border-emerald-500/50 transition-colors bg-white/[0.02]">
                        <input type="file" id="baplie-file" class="hidden" onchange="analyseerBaplie(event)">
                        <label for="baplie-file" class="cursor-pointer block">
                            <i class="fas fa-file-invoice text-4xl text-emerald-500 mb-4"></i>
                            <p class="text-sm text-white font-bold mb-1">Upload BAPLIE</p>
                            <p class="text-[10px] text-slate-500 uppercase tracking-widest">Auto-detect data</p>
                        </label>
                    </div>
                    <p id="baplie-status" class="text-[10px] font-bold text-center uppercase tracking-widest h-10"></p>
                </div>
            </div>
        </div>

        <div class="glass-card overflow-hidden">
            <table class="w-full text-left">
                <thead>
                    <tr class="text-[10px] text-slate-500 uppercase bg-slate-950/50">
                        <th class="px-8 py-4">Datum</th>
                        <th class="px-8 py-4">Reisnummer</th>
                        <th class="px-8 py-4 text-right">Containers</th>
                        <th class="px-8 py-4 text-right">Tonnage</th>
                    </tr>
                </thead>
                <tbody id="reis-lijst-body" class="divide-y divide-white/5 text-sm"></tbody>
            </table>
        </div>
    </main>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwZ0RhD4ZbytP12l9s6TwIaws_JXJSNnnw5rEIkM-2S1Qufm1-Tl2wYkuDOQe8FOL3T4Q/exec';
        let actueleData = [];

        function toggleInvoer() {
            const sectie = document.getElementById('input-sectie');
            sectie.classList.toggle('visible');
            if(sectie.classList.contains('visible')) sectie.scrollIntoView({ behavior: 'smooth' });
        }

        // Datum formatter hulpfunctie
        function formatteerDatum(datumString) {
            if(!datumString) return "-";
            const d = new Date(datumString);
            return d.toLocaleDateString('nl-NL', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        async function laadDataVanCloud() {
            const jaar = document.getElementById('filter-jaar').value;
            const icon = document.getElementById('refresh-icon');
            icon.classList.add('loading-spinner');
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'GET', redirect: 'follow' });
                const data = await response.json();
                
                // Filteren op jaar
                actueleData = data.filter(r => r.datum && r.datum.includes(jaar));
                
                // SORTEREN: Nieuwste datum bovenaan
                actueleData.sort((a, b) => new Date(b.datum) - new Date(a.datum));
                
                renderLijst(actueleData);
                updateStats(actueleData);
                document.getElementById('sync-text').innerText = "Cloud Verbonden";
                document.getElementById('stats-jaar').innerText = jaar;
            } catch (err) { console.error(err); } 
            finally { icon.classList.remove('loading-spinner'); }
        }

        function maakPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const jaar = document.getElementById('filter-jaar').value;
            
            const primaryColor = [15, 23, 42]; 
            const accentColor = [37, 99, 235];

            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, 210, 45, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont("helvetica", "bold");
            doc.setFontSize(24);
            doc.text("MS NEW MEXICO", 20, 20);
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            doc.text("OFFICIEEL TRANSPORT OVERZICHT", 20, 28);
            doc.text(`Periode: Januari - December ${jaar}`, 20, 34);

            doc.setFillColor(245, 245, 245);
            doc.roundedRect(15, 50, 180, 25, 3, 3, 'F');
            
            doc.setTextColor(100, 100, 100);
            doc.setFontSize(8);
            doc.text("TOTAAL REIZEN", 30, 58);
            doc.text("TOTAAL CONTAINERS (TEU)", 85, 58);
            doc.text("TOTAAL TONNAGE", 150, 58);

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text(document.getElementById('stat-reizen').innerText, 30, 68);
            doc.text(document.getElementById('stat-containers').innerText, 85, 68);
            doc.text(document.getElementById('stat-tonnage').innerText + " T", 150, 68);

            // Tabel data met geformatteerde datums
            const tabelData = actueleData.map(r => [
                formatteerDatum(r.datum), 
                r.nr, 
                r.containers, 
                parseFloat(r.tonnage).toLocaleString('nl-NL') + " T"
            ]);

            doc.autoTable({
                startY: 85,
                head: [['Datum', 'Reisnummer', 'Containers', 'Tonnage']],
                body: tabelData,
                theme: 'striped',
                headStyles: { 
                    fillColor: primaryColor, 
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    halign: 'center'
                },
                columnStyles: {
                    0: { halign: 'left' },
                    2: { halign: 'right' },
                    3: { halign: 'right' }
                },
                styles: { font: "helvetica", fontSize: 9 },
                margin: { left: 15, right: 15 }
            });

            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`Gegenereerd op: ${new Date().toLocaleString('nl-NL')}`, 15, 285);
                doc.text(`Pagina ${i} van ${pageCount}`, 180, 285);
            }

            doc.save(`MS-New-Mexico-Rapport-${jaar}.pdf`);
        }

        async function stuurNaarCloud(nr, kisten, ton) {
            // Gebruik ISO string voor opslag, wordt bij renderen geformatteerd
            const params = new URLSearchParams({
                datum: new Date().toISOString(),
                nr: nr, containers: kisten, tonnage: ton
            });
            try {
                await fetch(`${GOOGLE_SCRIPT_URL}?${params.toString()}`, { method: 'GET', mode: 'no-cors' });
                setTimeout(() => {
                    if(document.getElementById('input-sectie').classList.contains('visible')) toggleInvoer();
                    laadDataVanCloud();
                }, 2000);
            } catch (error) { alert("Fout bij opslaan."); }
        }

        function verwerkInvoer(e) {
            e.preventDefault();
            stuurNaarCloud(document.getElementById('reis-nr').value, document.getElementById('reis-kisten').value, document.getElementById('reis-ton').value);
            e.target.reset();
        }

        function analyseerBaplie(e) {
            const file = e.target.files[0];
            const status = document.getElementById('baplie-status');
            const reader = new FileReader();
            reader.onload = function(progressEvent) {
                const segments = progressEvent.target.result.split("'");
                let containers = 0; let totaalGewicht = 0; let gevondenReisNr = "";
                segments.forEach(segment => {
                    const line = segment.trim();
                    if (line.startsWith('TDT+20')) {
                        const onderdelen = line.split('+');
                        for (let i = onderdelen.length - 1; i >= 0; i--) {
                            const stukje = onderdelen[i].trim();
                            if (stukje && !isNaN(stukje) && stukje.length > 3) { gevondenReisNr = stukje; break; }
                        }
                    }
                    if (line.startsWith('LOC+147')) containers++;
                    if (line.includes('KGM:')) {
                        const waardeStuk = line.split('KGM:')[1];
                        if (waardeStuk) {
                            const gewichtSchoon = waardeStuk.split('+')[0].split(':')[0].trim();
                            const gewicht = parseFloat(gewichtSchoon);
                            if (!isNaN(gewicht)) totaalGewicht += (gewicht / 1000);
                        }
                    }
                });
                if (gevondenReisNr) {
                    status.innerHTML = `Detect: ${gevondenReisNr} | ${containers} kisten | ${totaalGewicht.toFixed(1)} T`;
                    status.className = "text-[10px] font-bold text-center text-emerald-500";
                    stuurNaarCloud(gevondenReisNr, containers, totaalGewicht.toFixed(1));
                }
            };
            reader.readAsText(file);
        }

        function renderLijst(reizen) {
            const body = document.getElementById('reis-lijst-body');
            body.innerHTML = reizen.map(r => `
                <tr class="hover:bg-white/[0.02] transition-colors">
                    <td class="px-8 py-4 text-slate-500">${formatteerDatum(r.datum)}</td>
                    <td class="px-8 py-4 font-bold text-white">${r.nr}</td>
                    <td class="px-8 py-4 text-right font-bold text-blue-400">${r.containers}</td>
                    <td class="px-8 py-4 text-right font-bold text-emerald-500">${parseFloat(r.tonnage).toLocaleString('nl-NL')} T</td>
                </tr>
            `).join('');
        }

        function updateStats(reizen) {
            const k = reizen.reduce((s, r) => s + (parseInt(r.containers) || 0), 0);
            const t = reizen.reduce((s, r) => s + (parseFloat(r.tonnage) || 0), 0);
            document.getElementById('stat-reizen').innerText = reizen.length;
            document.getElementById('stat-containers').innerText = k;
            document.getElementById('stat-tonnage').innerText = t.toLocaleString('nl-NL', {minimumFractionDigits: 1});
        }

        window.onload = laadDataVanCloud;
    </script>
</body>
</html>
